<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>旧端末向けキャラクターギャラリー</title>
<style>
html, body {
  margin:0;
  padding:0;
  overflow-x: auto;
  overflow-y: hidden;
  height:100%;
  width:100%;
  background: url('bg.jpg') no-repeat center center fixed;
  background-size: cover;
  touch-action: pan-x;
}
#gallery {
  white-space: nowrap;
  height:100%;
}
.char-container {
  display: inline-block;
  position: relative;
  vertical-align: bottom;
  text-align: center;
  height: 100%;
  margin: 0 10px;
}
.char-img {
  max-height: 100%;
  z-index: 3;
  cursor: pointer;
  position: relative;
}
#kumo {
  position: fixed;
  top:0;
  left:50%;
  transform: translateX(-50%);
  max-height:100%;
  z-index:2;
  pointer-events:none;
}
#txtBox {
  position: fixed;
  top:10px;
  left:50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,0.7);
  color:#fff;
  padding:10px;
  max-width:80%;
  display:none;
  z-index:4;
  white-space: pre-wrap;
}
</style>
</head>
<body>

<div id="gallery"></div>
<img id="kumo" src="">
<div id="txtBox"></div>

<script>
var charMap = {
  1: { img:"01.png", kumo:"kumo_b.png", txt:"01.txt" },
  2: { img:"02.png", kumo:"kumo_k.png", txt:"02.txt" },
  3: { img:"03.png", kumo:"kumo_w.png", txt:"03.txt" },
  4: { img:"04.png", kumo:"kumo_b.png", txt:"04.txt" }
};

var gallery = document.getElementById('gallery');
var txtBox = document.getElementById('txtBox');
var kumoImg = document.getElementById('kumo');
var currentIndex = 1;

// キャラクター生成
for (var key in charMap){
  var container = document.createElement('div');
  container.className = 'char-container';
  container.dataset.index = key;

  var charImg = document.createElement('img');
  charImg.className = 'char-img';
  charImg.src = charMap[key].img;
  container.appendChild(charImg);
  gallery.appendChild(container);
}

// 初期雲
kumoImg.src = charMap[currentIndex].kumo;

// 横スクロールに応じて雲切替
function updateKumo() {
  var containers = document.querySelectorAll('.char-container');
  var closest = currentIndex;
  var minDiff = Infinity;
  for(var i=0;i<containers.length;i++){
    var rect = containers[i].getBoundingClientRect();
    var diff = Math.abs(window.innerWidth/2 - (rect.left+rect.width/2));
    if(diff<minDiff){
      minDiff=diff;
      closest = parseInt(containers[i].dataset.index);
    }
  }
  if(closest!==currentIndex){
    currentIndex = closest;
    kumoImg.src = charMap[currentIndex].kumo;
    txtBox.style.display='none';
  }
}

gallery.addEventListener('scroll', updateKumo);

// 左右/中央タップ判定
var startX=0;
gallery.addEventListener('touchstart', function(e){ startX=e.touches[0].clientX; });
gallery.addEventListener('touchend', function(e){
  var endX = e.changedTouches[0].clientX;
  var diff = endX - startX;
  var w = window.innerWidth;
  // スワイプ
  if(diff>50 && currentIndex>1) scrollToIndex(currentIndex-1);
  else if(diff<-50 && currentIndex<Object.keys(charMap).length) scrollToIndex(currentIndex+1);
  else{
    // タップ領域
    if(endX<w*0.2 && currentIndex>1) scrollToIndex(currentIndex-1);
    else if(endX>w*0.8 && currentIndex<Object.keys(charMap).length) scrollToIndex(currentIndex+1);
    else showTxt(currentIndex);
  }
});

// スクロールして指定キャラクターを中央へ
function scrollToIndex(index){
  var container = document.querySelector('.char-container[data-index="'+index+'"]');
  if(container){
    var rect = container.getBoundingClientRect();
    gallery.scrollLeft += rect.left + rect.width/2 - window.innerWidth/2;
    currentIndex = index;
    kumoImg.src = charMap[currentIndex].kumo;
    txtBox.style.display='none';
  }
}

// テキスト表示（古いブラウザ対応 XMLHttpRequest）
function showTxt(index){
  var txtFile = charMap[index].txt;
  var xhr = new XMLHttpRequest();
  xhr.open('GET', txtFile, true);
  xhr.onreadystatechange = function(){
    if(xhr.readyState==4 && xhr.status==200){
      txtBox.textContent = xhr.responseText;
      txtBox.style.display='block';
    }
  };
  xhr.send();
}

// リサイズ対応
function resizeImgs(){
  var imgs = document.querySelectorAll('.char-img');
  for(var i=0;i<imgs.length;i++){ imgs[i].style.maxHeight = window.innerHeight+'px'; }
  kumoImg.style.maxHeight = window.innerHeight+'px';
}
window.addEventListener('resize', resizeImgs);
resizeImgs();
</script>

</body>
</html>
