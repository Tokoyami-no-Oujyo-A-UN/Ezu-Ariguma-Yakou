<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>キャラクター巻物UI</title>
<style>
html, body {
  margin: 0;
  padding: 0;
  overflow-x: hidden;
  height: 100%;
  font-family: sans-serif;
}

#background {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url("bg.jpg");
  background-size: cover;
  z-index: 0;
}

#kumo {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%; /* キャラ画像と同じ縦サイズ */
  width: auto;
  z-index: 1;
  pointer-events: none;
  transition: opacity 0.5s ease;
}

#scroll-container {
  position: relative;
  white-space: nowrap;
  overflow-x: scroll;
  overflow-y: hidden;
  height: 100%;
  z-index: 2;
  scroll-behavior: smooth;
}

.item {
  display: inline-block;
  height: 100%;
}

.item img {
  height: 100%;
  display: block;
}

#detail-panel {
  position: absolute;
  top: 4%;  /* 上に4%あける */
  left: 4%;
  width: 92%;
  max-height: 40%;
  background-color: rgba(0,0,0,0.7);
  color: #fff;
  padding: 10px;
  overflow-y: auto;
  border-radius: 8px;
  display: none;
  z-index: 100;
  line-height: 1.3; /* 改行幅30%増 */
}

#detail-panel p {
  line-height: 1.3; /* txt内部も適用 */
  margin: 0;
}

#detail-close {
  position: absolute;
  top: 5px;
  right: 5px;
  width: 30px;
  height: 30px;
  cursor: pointer;
}

.nav-btn {
  position: fixed;
  bottom: 4%;
  height: 15%;
  cursor: pointer;
  z-index: 200;
}

#prev { left: 4%; }
#next { left: calc(4% + 15% + 5px); }
#detail-toggle { left: calc(4% + 2*(15% + 5px)); }
</style>
</head>
<body>
<div id="background"></div>
<img id="kumo" src="kumo_w.png" alt="雲">
<div id="scroll-container"></div>

<div id="detail-panel">
  <div id="detail-close"><img src="0moji_cl.png" style="width:100%; height:100%;"></div>
  <div id="detail-text"></div>
</div>

<img id="prev" class="nav-btn" src="0left.png">
<img id="next" class="nav-btn" src="0right.png">
<img id="detail-toggle" class="nav-btn" src="0moji_op.png">

<script>

// キャラクターマップ（番号: {img, kumo, txt}）
const charMap = {
  1: { img:"01.png", kumo:"kumo_b.png", txt:"01.txt" },
  2: { img:"02.png", kumo:"kumo_k.png", txt:"02.txt" },
  3: { img:"03.png", kumo:"kumo_w.png", txt:"03.txt" },
  4: { img:"04.png", kumo:"kumo_b.png", txt:"04.txt" }
  // 必要に応じて追加
};

const scrollContainer = document.getElementById('scroll-container');
const detailPanel = document.getElementById('detail-panel');
const detailText = document.getElementById('detail-text');
const detailClose = document.getElementById('detail-close');
const kumoImg = document.getElementById('kumo');

let currentIndex = Object.keys(charMap).length; // 初期表示は最大番号
let txtOpen = false;

// 画像生成
for (let i=1;i<=Object.keys(charMap).length;i++){
  const div = document.createElement('div');
  div.className = 'item';
  const img = document.createElement('img');
  img.src = charMap[i].img;
  div.appendChild(img);
  scrollContainer.appendChild(div);
}

// 中央寄せスクロール
function smoothScrollTo(container, targetLeft, duration = 2000){
  const start = container.scrollLeft;
  const change = targetLeft - start;
  const startTime = performance.now();
  function animate(time){
    const elapsed = time - startTime;
    const progress = Math.min(elapsed/duration,1);
    container.scrollLeft = start + change * easeInOutQuad(progress);
    if(progress<1) requestAnimationFrame(animate);
  }
  function easeInOutQuad(t){ return t<0.5?2*t*t:-1+(4-2*t)*t; }
  requestAnimationFrame(animate);
}

function scrollToCurrent(){
  const items = document.querySelectorAll('.item');
  const target = items[currentIndex-1];
  if(!target) return;
  const container = scrollContainer;
  let targetLeft = target.offsetLeft - (container.offsetWidth - target.offsetWidth)/2;
  // 端画像は端表示
  if(currentIndex===1) targetLeft = 0;
  if(currentIndex===Object.keys(charMap).length) targetLeft = container.scrollWidth - container.offsetWidth;
  smoothScrollTo(container,targetLeft,2000);
  updateKumo(currentIndex);
  if(txtOpen) closeDetail();
}

// 雲更新
function updateKumo(index){
  const kumoFile = charMap[index].kumo;
  if(kumoImg.src.includes(kumoFile)) return;
  const newKumo = document.createElement('img');
  newKumo.src = kumoFile;
  newKumo.style.position='absolute';
  newKumo.style.top='0';
  newKumo.style.left='0';
  newKumo.style.height='100%';
  newKumo.style.width='auto';
  newKumo.style.zIndex='1';
  newKumo.style.opacity='0';
  newKumo.style.transition='opacity 0.5s';
  document.body.appendChild(newKumo);
  requestAnimationFrame(()=>{ newKumo.style.opacity='1'; });
  setTimeout(()=>{ kumoImg.src = kumoFile; newKumo.remove(); },500);
}

// ナビ
document.getElementById('next').addEventListener('click',()=>{
  if(currentIndex<Object.keys(charMap).length) currentIndex++;
  scrollToCurrent();
});
document.getElementById('prev').addEventListener('click',()=>{
  if(currentIndex>1) currentIndex--;
  scrollToCurrent();
});

// txt
document.getElementById('detail-toggle').addEventListener('click',()=>{
  if(txtOpen){ closeDetail(); } else { openDetail(); }
});
detailClose.addEventListener('click', closeDetail);

function openDetail(){
  txtOpen = true;
  const txtFile = charMap[currentIndex].txt;
  fetch(txtFile)
    .then(res=>res.text())
    .then(data=>{ detailText.innerText=data; detailPanel.style.display='block'; });
}
function closeDetail(){ txtOpen=false; detailPanel.style.display='none'; detailText.innerText=''; }

// 初期位置
window.addEventListener('load',()=>{ scrollToCurrent(); });

// 雲横スクロール連動（パララックス）
scrollContainer.addEventListener('scroll',()=>{
  kumoImg.style.left = -scrollContainer.scrollLeft*0.3 + 'px';
});

// タッチ操作対応（スマホ）
let startX=0, scrollStart=0;
scrollContainer.addEventListener('touchstart', e=>{ startX=e.touches[0].pageX; scrollStart=scrollContainer.scrollLeft; });
scrollContainer.addEventListener('touchmove', e=>{
  const dx=startX - e.touches[0].pageX;
  scrollContainer.scrollLeft=scrollStart+dx;
});
</script>
</body>
</html>
